<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="decks-list.html">

<dom-module id="add-card">
  <template>

  <style include="shared-styles">
  :host {
    display: block;

    padding: 10px;
  }
  </style>

  <div class="row">
    <div class="col-6">
      <decks-list class="col-2 intends"
      uid="[[firebaseUser.uid]]"
      selected-deck-key="{{deckId}}">
    </decks-list>
  </div>
  <div class="col-4" id="add-progress" style="display: none;">Добавлена</div>
</div>

<!--TODO(ksheremet): check maxRows. -->
<div class="row">
  <paper-textarea class="col-12 intends" id="front" name="front"
  maxRows="5" label="Введите переднюю сторону карточки"
  value="{{frontSide}}"></paper-extarea>
</div>

<div class="row">
  <paper-textarea class="col-12 intends" id="back" name="back"
  maxRows="5" label="Введите обратную сторону карточки"
  value="{{backSide}}"></paper-textarea>
</div>

<div class="intends row">
  <paper-toggle-button checked="{{reversed}}" title="Добавить обратную карточку">
    Добавить обратную карточку
  </paper-toggle-button>
  </div

  <div class="row">
    <paper-button raised id="add-card" on-click="addCard" class="intends">
      Добавить
    </paper-button>
  </div>
</template>

<script>
class AddCard extends Polymer.Element {
  static get is() { return 'add-card'; }

  static get properties() {
    return {
      firebaseUser: {
        type: Object,
        notify: true,
      },
      deckId: String,
      frontSide: {
        type: String,
        value: '',
        notify: true,
      },
      backSide: {
        type: String,
        value: '',
        notify: true,
      },
      reversed: {
        type: Boolean,
        value: false,
      }
    };
  }

  addCard() {
    if (this.frontSide.length == 0) {
      alert("Передняя сторона карточки пуста");
      return;
    }

    var card = {
      front: this.frontSide,
      back: this.backSide,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
    };

    var scheduled = {
      level: "L0",
      repeatAt: (new Date()).getTime(),
    };

    var newCardKey = firebase.database().ref().child('cards').child(this.deckId).push().key;

    // Write the new post's data simultaneously in the posts list and the user's post list.
    var updates = {};
    updates['/cards/' + this.deckId +'/' + newCardKey] = card;
    updates['/learning/' + this.firebaseUser.uid + '/' + this.deckId + '/' +
    newCardKey] = scheduled;
    // Add reversed card.
    if (this.reversed) {
      var cardReversed = {
        front: this.backSide,
        back: this.frontSide,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
      };
      var newCardKeyReversed = firebase.database().ref().child('cards').child(this.deckId).push().key;
      updates['/cards/' + this.deckId +'/' + newCardKeyReversed] = cardReversed;
      updates['/learning/' + this.firebaseUser.uid + '/' + this.deckId + '/' +
      newCardKeyReversed] = scheduled;
    };

    this.$['add-card'].disabled = true;
    var self = this;
    firebase.database().ref().update(updates).then(function() {
      self.$['add-card'].disabled = false;
      self.frontSide = '';
      self.backSide = '';
      self.$.front.focus();
      setTimeout(function () {
        self.$['add-progress'].style.display = 'none';
      }, 3000);
      self.$['add-progress'].style.display = 'inline';
    }).catch(function(err) {
      self.$['add-card'].disabled = false;
      alert(err);
    });
  }
}

window.customElements.define(AddCard.is, AddCard);
</script>
</dom-module>
